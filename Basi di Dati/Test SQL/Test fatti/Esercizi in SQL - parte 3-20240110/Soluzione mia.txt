--1
select r.codice, r.giorno, r.valore
from rilevazione r
	join centralina c on c.codice = r.codice
	join citta ci on ci.id = c.citta
where r.valore > 100 and c.tipo != 1 and ci.nome = 'Milano';

--2
select c.codice, ci.regione, avg(valore)
from rilevazione r 
	join centralina c on c.codice = r.codice
	join citta ci on c.citta = ci.id
group by c.codice, regione;

--3
select r1.codice
from rilevazione r1
	join rilevazione r2 on r1.codice = r2.codice
where r1.giorno = r2.giorno+1 and r1.valore = r2.valore;

--4
select distinct codice
from rilevazione r
where not exists (
	select r1.codice
	from rilevazione r1
	where giorno >= 90 and r.codice = r1.codice
	group by r1.codice
);

--5
with livello_di_inquinamento (regione, media_inquinamento_regione) as(
	select regione, avg(valore)
	from rilevazione r
		join centralina c on c.codice = r.codice
		join citta ci on ci.id = c.citta
	group by regione
)
select l.regione 
from livello_di_inquinamento l
where media_inquinamento_regione < (select avg(valore)
				from rilevazione
				)