-- 1
select distinct codiceg
from giocatore g 
	join giocato gio on g.codice = gio.codiceg
	join squadra s on s.nome = gio.nomes
where prestigio < 3;

--2 
select distinct codiceg, cognome
from giocato gio 
	join giocatore g on codice = codiceg
	join squadra s on nome = nomes
where prestigio <= 4 and gol > 20;

--3
select codice, cognome 
from giocato gio 
	join giocatore g on codice = codiceg
group by codice
having sum(gol) = 0;

--4
with squadra_prestigio_minore_3	(nome, prestigio) as (
	select nome, prestigio
	from squadra
	where prestigio < 3
)
select nome as nome_squadra, count(codiceg)
from squadra_prestigio_minore_3 s 
	join giocato gio on nomes = nome
	join giocatore g on codice = codiceg
where gol > 10
group by nome;

--5
with squadra_prestigio_maggiore_4 (nome, prestigio) as (
	select nome, prestigio
	from squadra
	where prestigio >= 4
)
select nome as nome_squadra, avg(gol)
from squadra_prestigio_maggiore_4 s 
	join giocato gio on nomes = nome
	join giocatore g on codice = codiceg
group by nome;

--6
with giocatore_eta_maggiore_28 (codice, cognome, eta) as (
	select codice, cognome, eta
	from giocatore
	where eta >= 28
)
select codice, avg(gol)
from giocatore_eta_maggiore_28 as g
	join giocato gio on codice = codiceg
	join squadra s on nome = nomes
group by nome, codice
having avg(gol) > 15;

--7
with giocatori_milan (codiceg) as (
	select codiceg
	from giocato
	group by codiceg
	having count(distinct nomes) = 1 and max(nomes) = 'Milan'
)
select codice, cognome, gol
from giocatori_milan gm
	join giocatore on gm.codiceg = codice
	join giocato g on gm.codiceg = g.codiceg;

--8
with max_gol_squadra (nome, numero_gol) as (
	select nomes, max(gol)
	from giocato
	group by nomes
)
select nomes, codiceg, numero_gol
from max_gol_squadra s
	join giocato on nome = nomes
group by nomes, codiceg, numero_gol
having numero_gol = max(gol)
order by nomes;

--9
select g1.codice,g2.codice
from giocatore g1 join giocatore g2 on g1.codice<g2.codice
where not exists (
	select nome
	from squadra
	where (nome in (
		select nomes
		from giocato
		where codiceg = g1.codice
		)
	and	nome not in (
		select nomes
		from giocato
		where codiceg = g2.codice
		))
	or (nome in (
		select nomes
		from giocato
		where codiceg = g2.codice
		)
	and	nome not in (
		select nomes
		from giocato
		where codiceg = g1.codice
		))
)
