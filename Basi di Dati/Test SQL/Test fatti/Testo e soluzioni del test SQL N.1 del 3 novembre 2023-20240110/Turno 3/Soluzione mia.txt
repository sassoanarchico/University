--1 
select distinct s.codicestella, galassia
from stella s
	join missione m on s.codicestella = m.codicestella
where anno > 100;

--2
select s.codicestella, count(equipaggio)
from missione m 
	join stella s on s.codicestella = m.codicestella
where galassia = 'Andromeda'
group by s.codicestella;

--3
delete from missione where equipaggio = 10;
insert into missione values (10, 'S2', 200);

select equipaggio
from missione 
where equipaggio not in (
	select equipaggio
	from missione m 
		join stella s on s.codicestella = m.codicestella
	where galassia != 'Magellano'
);

--4
with ha_visitato (nomeastronauta, equipaggio, codicestella, anno) as (
	select nomeastronauta, m.equipaggio, codicestella, anno
	from missione m
		join membro me on m.equipaggio = me.equipaggio
)
select codicestella, count(distinct nomeastronauta)
from ha_visitato 
group by codicestella;

--5
select s1.codicestella , s2.codicestella
from stella s1
	join stella s2 on s1.codicestella < s2.codicestella
where not exists (select nomeastronauta, anno
				 from missione m1
				 	join membro me1 on m1.equipaggio = me1.equipaggio
				 where m1.codicestella = s1.codicestella and (nomeastronauta, anno) not in (
				 	select nomeastronauta, anno
				 	from missione m2 
				 		join membro me2 on m2.equipaggio = me2.equipaggio
				 	where m2.codicestella = s2.codicestella)
) and not exists (
	select nomeastronauta, anno
	from missione m1
		join membro me1 on m1.equipaggio = me1.equipaggio
	where m1.codicestella = s2.codicestella and (nomeastronauta, anno) not in (
		select nomeastronauta, anno
		from missione m2 
			join membro me2 on m2.equipaggio = me2.equipaggio
		where m2.codicestella = s1.codicestella)
)
