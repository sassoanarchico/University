--1
select distinct m.codicemuseo, citta
from museo m
	join ingresso i on m.codicemuseo = i.codicemuseo
where giorno > 31;

--2
select m.codicemuseo, count(i)
from museo m
	join ingresso i on m.codicemuseo = i.codicemuseo
where tipo = 'arte moderna'
group by m.codicemuseo;

--3
delete from ingresso where gruppo = 11;
delete from iscritto where nomepersona = 'caio';
delete from persona where nome = 'caio';
insert into persona values ('caio', 32);
insert into iscritto values ('caio', 11);
insert into ingresso values (11, 'M5', 30);

select isc.gruppo
from iscritto isc
where isc.gruppo not in (select gruppo
					 from ingresso i
					 	join museo m on i.codicemuseo = m.codicemuseo
					 where citta != 'Roma'
)
union 
select ing.gruppo
from ingresso ing
where ing.gruppo not in (select gruppo
					 from ingresso i
					 	join museo m on i.codicemuseo = m.codicemuseo
					 where citta != 'Roma'
);

--4
with ha_effettuato as (
	select nomepersona, i.gruppo, codicemuseo, giorno
	from iscritto iss 
		join ingresso i on i.gruppo = iss.gruppo
)
select m.codicemuseo, count(distinct nomepersona)
from museo m
	left join ha_effettuato e on e.codicemuseo = m.codicemuseo
group by m.codicemuseo;

--5
with e5 as (
	select giorno, codicemuseo, nomepersona
	from iscritto isc
		join ingresso i on isc.gruppo = i.gruppo
	group by giorno, codicemuseo, nomepersona
)
select m1.codicemuseo, m2.codicemuseo, m1.giorno
from e5 m1 join e5 m2 on m1.codicemuseo < m2.codicemuseo and m1.giorno = m2.giorno
group by m1.giorno, m1.codicemuseo, m2.codicemuseo
having count(m1.nomepersona) = count(m2.nomepersona);




SELECT m1.codicemuseo as equipollente1, m2.codicemuseo as equipollente2
FROM museo as m1, museo as m2
WHERE m1.codicemuseo < m2.codicemuseo and NOT EXISTS (SELECT nomepersona, giorno
				  						    FROM ingresso as ing1 JOIN iscritto as ins1 ON ing1.gruppo = ins1.gruppo
				  						    WHERE ing1.codicemuseo = m1.codicemuseo and (nomepersona,giorno) NOT IN (
												SELECT nomepersona, giorno
				  						    	FROM ingresso as ing2 JOIN iscritto as ins2 ON ing2.gruppo = ins2.gruppo
				  						    	WHERE ing2.codicemuseo = m2.codicemuseo
										   )
	) and NOT EXISTS (SELECT nomepersona, giorno
					  FROM ingresso as ing1 JOIN iscritto as ins1 ON ing1.gruppo = ins1.gruppo
					  WHERE ing1.codicemuseo = m2.codicemuseo and (nomepersona, giorno) NOT IN (
							SELECT nomepersona, giorno
							FROM ingresso as ing2 JOIN iscritto as ins2 ON ing2.gruppo = ins2.gruppo
							WHERE ing2.codicemuseo = m1.codicemuseo
						    )
					 )
